/*
 (c) 2015, iosphere GmbH
 Leaflet.hotline, a Leaflet plugin for drawing gradients along polylines.
 https://github.com/iosphere/Leaflet.hotline/
*/
!function(t,i){"function"==typeof define&&define.amd?define(["leaflet"],i):"object"==typeof exports?module.exports=i:i(t.L)}(this,function(t){if(t.Hotline)return t;var i=function(t){if(!(this instanceof i))return new i(t);var e={0:"green",.5:"yellow",1:"red"};this._canvas=t="string"==typeof t?document.getElementById(t):t,this._ctx=t.getContext("2d"),this._width=t.width,this._height=t.height,this._weight=5,this._outlineWidth=1,this._outlineColor="black",this._min=0,this._max=1,this._data=[],this.palette(e)};i.prototype={width:function(t){return this._width=t,this},height:function(t){return this._height=t,this},weight:function(t){return this._weight=t,this},outlineWidth:function(t){return this._outlineWidth=t,this},outlineColor:function(t){return this._outlineColor=t,this},palette:function(t){var i=document.createElement("canvas"),e=i.getContext("2d"),n=e.createLinearGradient(0,0,0,256);i.width=1,i.height=256;for(var o in t)n.addColorStop(o,t[o]);return e.fillStyle=n,e.fillRect(0,0,1,256),this._palette=e.getImageData(0,0,1,256).data,this},min:function(t){return this._min=t,this},max:function(t){return this._max=t,this},data:function(t){return this._data=t,this},add:function(t){return this._data.push(t),this},clear:function(t){return t&&(this._data=[]),this._ctx.clearRect(0,0,this._width,this._height),this},draw:function(t){var i=this._ctx;return i.globalCompositeOperation=t?"destination-out":"source-over",i.lineCap="round",this._drawOutline(i,t),t?this:(this._drawHotline(i),this)},_drawOutline:function(t,i){var e,n,o,h,s,r,a,l;if(i||this._outlineWidth)for(e=0,o=this._data.length;o>e;e++)for(h=this._data[e],s=this._weight+2*this._outlineWidth,h._prevWidth=t.lineWidth=i?(h._prevWidth||s)+1:s,n=1,r=h.length;r>n;n++)a=h[n-1],l=h[n],t.strokeStyle=this._outlineColor,t.beginPath(),t.moveTo(a.x,a.y),t.lineTo(l.x,l.y),t.stroke()},_drawHotline:function(t){var i,e,n,o,h,s,r,a,l,_,u,d;for(t.lineWidth=this._weight,i=0,n=this._data.length;n>i;i++)for(o=this._data[i],e=1,h=o.length;h>e;e++)s=o[e-1],r=o[e],a=Math.min(Math.max((s.z-this._min)/(this._max-this._min),0),.99),l=Math.min(Math.max((r.z-this._min)/(this._max-this._min),0),.99),_=t.createLinearGradient(s.x,s.y,r.x,r.y),u=4*Math.floor(256*a),d=4*Math.floor(256*l),_.addColorStop(0,"rgba("+this._palette[u]+","+this._palette[u+1]+","+this._palette[u+2]+",1)"),_.addColorStop(1,"rgba("+this._palette[d]+","+this._palette[d+1]+","+this._palette[d+2]+",1)"),t.strokeStyle=_,t.beginPath(),t.moveTo(s.x,s.y),t.lineTo(r.x,r.y),t.stroke()}};var e=t.Canvas.extend({_initContainer:function(){t.Canvas.prototype._initContainer.call(this),this._hotline=new i(this._container)},_update:function(){t.Canvas.prototype._update.call(this),this._hotline.width(this._container.width),this._hotline.height(this._container.height)},_updatePoly:function(t){var i=t._parts;i.length&&(this._updateOptions(t),this._hotline.data(i).draw(this._clear))},_updateOptions:function(t){null!=t.options.min&&this._hotline.min(t.options.min),null!=t.options.max&&this._hotline.max(t.options.max),null!=t.options.weight&&this._hotline.weight(t.options.weight),null!=t.options.outlineWidth&&this._hotline.outlineWidth(t.options.outlineWidth),null!=t.options.outlineColor&&this._hotline.outlineColor(t.options.outlineColor),t.options.palette&&this._hotline.palette(t.options.palette)}}),n=function(i){return t.Browser.canvas?new e(i):null},o={clipSegment:function(i,e,n,o,h){var s,r,a,l=o?this._lastCode:t.LineUtil._getBitCode(i,n),_=t.LineUtil._getBitCode(e,n);for(this._lastCode=_;;){if(!(l|_))return[i,e];if(l&_)return!1;s=l||_,r=t.LineUtil._getEdgeIntersection(i,e,s,n,h),a=t.LineUtil._getBitCode(r,n),s===l?(r.z=i.z,i=r,l=a):(r.z=e.z,e=r,_=a)}}};return t.Hotline=t.Polyline.extend({statics:{Renderer:e,renderer:n},options:{renderer:n(),min:0,max:1,palette:{0:"green",.5:"yellow",1:"red"},weight:5,outlineColor:"black",outlineWidth:1},_projectLatlngs:function(i,e){var n,o,h=i[0]instanceof t.LatLng,s=i.length;if(h){for(o=[],n=0;s>n;n++)o[n]=this._map.latLngToLayerPoint(i[n]),o[n].z=i[n].alt;e.push(o)}else for(n=0;s>n;n++)this._projectLatlngs(i[n],e)},_clipPoints:function(){if(this.options.noClip)return void(this._parts=this._rings);this._parts=[];var t,i,e,n,h,s,r,a=this._parts,l=this._renderer._bounds;for(t=0,e=0,n=this._rings.length;n>t;t++)for(r=this._rings[t],i=0,h=r.length;h-1>i;i++)s=o.clipSegment(r[i],r[i+1],l,i,!0),s&&(a[e]=a[e]||[],a[e].push(s[0]),(s[1]!==r[i+1]||i===h-2)&&(a[e].push(s[1]),e++))},_clickTolerance:function(){return this.options.weight/2+this.options.outlineWidth+(t.Browser.touch?10:0)}}),t.hotline=function(i,e){return new t.Hotline(i,e)},t});
